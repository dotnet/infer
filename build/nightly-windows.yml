# Licensed to the .NET Foundation under one or more agreements.
# The .NET Foundation licenses this file to you under the MIT license.
# See the LICENSE file in the project root for more information.

# Nightly build for Windows. Tests on x86 and x64. Produces NuGet packages

name: 0.3.$(Date:yyMM).$(Date:dd)$(Rev:rr)

resources:
- repo: self
  clean: true
  
trigger: none # disable CI build

queue:
  name: Hosted VS2017

jobs:
- job: Windows Test 
  timeoutInMinutes: 180
  strategy:
    matrix:
      x64:
        TEST_PLATFORM: 'x64'
      x86:
        TEST_PLATFORM: 'x86'
    maxParallel: 2
  
  steps:
  - template: windows-msbuild.yml
    parameters:
      BuildConfiguration: '$(BuildConfiguration)'  
      BuildNumber: '$(Build.BuildNumber)'

  - template: vstest-fast.yml
    parameters:
      Platform: $(TEST_PLATFORM)


- job: Windows Evaluator
  timeoutInMinutes: 180

  steps:
  - template: windows-msbuild.yml
    parameters:
      BuildConfiguration: '$(BuildConfiguration)'  
      BuildNumber: '$(Build.BuildNumber)'

  - template: evaluator-netcore.yml
    parameters:
      Configuration: '$(BuildConfiguration)'

  - template: evaluator-netframework.yml
    parameters:
      Configuration: '$(BuildConfiguration)'


- job: Package and Publish
  timeoutInMinutes: 30
  dependsOn: 
  - Windows Test
  - Windows Evaluator

  steps:
  - template: windows-msbuild.yml
    parameters:
      BuildConfiguration: '$(BuildConfiguration)'  
      BuildNumber: '$(Build.BuildNumber)'

  - task: Bash@3
    displayName: 'Gathering built assemblies'
    condition: eq(variables['BuildConfiguration'], 'Release')
    inputs:
      filePath: build/copyassemblies.sh
      arguments: ../bin $(BuildConfiguration)
      workingDirectory: build

  - task: NuGetCommand@2
    displayName: 'Creating NuGet packages'
    condition: eq(variables['BuildConfiguration'], 'Release')
    inputs:
      command: pack
      packagesToPack: build/*.nuspec
      includeSymbols: true
      buildProperties: version=$(Build.BuildNumber);bin=../bin

  - task: CopyFiles@2
    displayName: 'Copying build artifacts'
    condition: eq(variables['BuildConfiguration'], 'Release')
    inputs:
      sourceFolder: bin
      targetFolder: $(Build.ArtifactStagingDirectory)

  - task: PublishBuildArtifacts@1
    displayName: 'Publishing build artifacts'
    condition: eq(variables['BuildConfiguration'], 'Release')
    inputs:
      artifactName: 'Everything'